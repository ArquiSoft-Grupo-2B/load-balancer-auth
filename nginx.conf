worker_processes auto;

events {
  worker_connections 1024;
}

http {
    # Formato de log personalizado que muestra el servidor upstream
    log_format upstream_log '[$time_local] Client: $remote_addr - '
                           'Request: "$request" - '
                           'Status: $status - '
                           'Upstream: $upstream_addr - '
                           'Backend Server: $upstream_addr';
    
    access_log /var/log/nginx/access.log upstream_log;

    upstream auth_backend {
        least_conn; # Use least connections load balancing
        server authentication-service:8000;
        server authentication-service-1:8001;
        server authentication-service-2:8002;

        # Mantener conexiones persistentes
        keepalive 32;

        # Timeout para fallos
        fail_timeout 30s; 
    }

    server {
        listen 9001;

        location / {
            proxy_pass http://auth_backend;
        }

        location /health {
            return 200 'Load Balancer is healthy';
            add_header Content-Type text/plain;
        }
    }
}
